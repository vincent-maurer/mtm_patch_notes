<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTM Workshop System Documenter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --panel-bg: #2d3748; 
            --ink: #cbd5e1;
            --jack-inner: #94a3b8;
            --knob-indicator: #000000;
            --switch-handle: #000000;
            --button-active: #ef4444;
            --button-border: #94a3b8;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            user-select: none;
            min-height: 100vh;
            color: #333333;
        }

        .synth-container {
            position: relative;
            width: 100%; 
            height: 0;
            padding-top: 60%; 
            background-color: var(--panel-bg);
            background-image: url('https://github.com/vincent-maurer/mtm_patch_notes/blob/main/panel_image.png?raw=true'); 
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 4px;
            /* Removed box-shadow */
            overflow: hidden;
            border: 1px solid #e5e7eb; /* Added subtle border for definition */
        }
        
        .component {
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }
        
        .jack {
            width: 2.4%;
            height: 0;
            padding-bottom: 2.2%; 
            background: var(--jack-inner);
            border: 2px solid var(--ink);
            border-radius: 50%;
            transition: all 0.1s;
            opacity: 0.3; 
        }
        .jack:hover { opacity: 0.8; box-shadow: 0 0 8px var(--jack-inner); transform: translate(-50%, -50%) scale(1.1); }
        .jack.active { opacity: 0.9; box-shadow: 0 0 10px 3px #fcd34d; border-color: #fcd34d; }
        
        .knob-large, .knob-medium, .knob-small {
            border-radius: 50%;
        }
        
        .knob-large { width: 11.5%; padding-bottom: 11.5%; height: 0; }
        .knob-medium { width: 5.0%; padding-bottom: 5.0%; height: 0; }
        .knob-small { width: 2.8%; padding-bottom: 2.8%; height: 0; }

        .knob-large::after, .knob-medium::after, .knob-small::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 50%;
            transform-origin: bottom center;
            width: 3px; 
            background: var(--knob-indicator);
            border-radius: 2px;
            transform: rotate(calc(var(--angle) * 1deg));
            pointer-events: none;
        }
        
        .knob-large::after { height: 50%; } 
        .knob-medium::after { height: 50%; }
        .knob-small::after { height: 50%; } 

        .switch-2way, .switch-3way {
            width: 1.2%; 
            height: 0;
            background: transparent; 
            border-radius: 2px;
        }

        .switch-2way { padding-bottom: 2.5%; }
        .switch-3way { padding-bottom: 3.75%; } 

        #switch-2way-191 {
            transform: translate(-50%, -50%) rotate(-90deg);
        }

        .switch-handle {
            position: absolute;
            left: 0; 
            width: 100%;
            height: 25%;
            background: var(--switch-handle);
            border-radius: 8px;
            transition: top 0.1s ease-out;
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .switch-2way .switch-handle { height: 40%; }
        .switch-2way[data-state="0"] .switch-handle { top: 0%; } 
        .switch-2way[data-state="1"] .switch-handle { top: 60%; } 

        .switch-3way .switch-handle { height: 25%; }
        .switch-3way[data-state="0"] .switch-handle { top: 0%; } 
        .switch-3way[data-state="1"] .switch-handle { top: 40%; } 
        .switch-3way[data-state="2"] .switch-handle { top: 80%; } 

        .button {
            width: 4.2%;          
            padding-bottom: 4.1%; 
            height: 0;
            background: rgba(0, 0, 0, 0.05);
            border: 0px solid var(--button-border);
            border-radius: 50%;   
            transition: all 0.1s ease;
            box-sizing: border-box;
        }
        .button[data-state="1"] {
            background: var(--button-active);
            border-color: #fca5a5;
            box-shadow: 0 0 12px var(--button-active);
        }

        .cable-svg {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
        }
        .cable-svg path {
            fill: none; stroke-width: 6;
            stroke-linecap: round;
            transition: d 0.1s ease-out; opacity: 0.6;
            cursor: pointer; pointer-events: auto;
            filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.5));
        }
        .cable-svg path:hover { stroke-width: 9; opacity: 1.0; stroke: #000000; }
        
        .note-element {
            min-width: 50px; 
            padding: 2px 6px;
            background-color: transparent; 
            color: #000000; 
            font-weight: 800;
            text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            font-size: 1.1rem;
            border: 1px dashed rgba(0,0,0,0.3);
            border-radius: 4px;
            position: absolute; 
            transform: translate(-50%, -50%); 
            z-index: 20; 
            cursor: grab;
            white-space: nowrap;
        }
        .note-element:hover { border: 1px dashed rgba(0,0,0,0.8); background: rgba(0,0,0,0.05); } 
        .note-element:focus { border: 1px solid #000; outline: none; background: rgba(255,255,255,0.8); cursor: text; }
    </style>
</head>
<body class="min-h-screen">

    <header class="text-center mb-4">
        <h1 class="text-3xl font-bold text-gray-800 mb-1">MTM Workshop System Patch Notes</h1>
    </header>

    <div class="w-full max-w-[1500px] flex flex-col gap-4 px-4">
        
        <div class="w-full bg-white p-2 rounded border border-gray-300">
            <label for="patchNameInput" class="block text-sm font-medium text-gray-600 mb-1">Patch Name</label>
            <input type="text" id="patchNameInput" class="w-full bg-white text-gray-900 text-xl p-2 rounded border border-gray-400 focus:outline-none focus:border-indigo-500" placeholder="Untitled Patch">
        </div>

        <div class="flex flex-wrap gap-2 justify-center bg-gray-100 p-3 rounded-lg mb-0 w-full border border-gray-300">
            <button id="addNoteButton" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition font-medium">
                + Label
            </button>
            <div class="w-px bg-gray-600 mx-2"></div>
            <button id="savePatchButton" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition font-medium">
                Save Patch
            </button>
            <input type="file" id="loadPatchInput" accept=".json" style="display: none;" />
            <button id="loadPatchButton" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition font-medium">
                Load Patch
            </button>
            <div class="w-px bg-gray-600 mx-2"></div>
            <button id="savePngButton" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition font-medium">
                PNG
            </button>
            <button id="savePdfButton" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition font-medium">
                PDF
            </button>
            <button id="clearButton" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition font-medium">
                Reset
            </button>
        </div>

        <div class="synth-container" id="synthContainer">
            <svg class="cable-svg" id="cableLayer"></svg>
            </div>
        
        <div class="w-full bg-gray-100 p-6 rounded-lg border border-gray-300">
            <div class="flex flex-col gap-4">
                <div>
                    <label for="globalNotesArea" class="block text-sm font-medium text-gray-600 mb-1">Notes</label>
                    <textarea id="globalNotesArea" class="w-full h-40 bg-white text-gray-900 p-3 rounded border border-gray-400 focus:outline-none focus:border-indigo-500 font-mono text-sm" 
                    placeholder="Describe signal flow, settings, and ideas here..."></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <div id="messageBox" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-2xl transition-opacity duration-300 opacity-0 hidden z-50"></div>
    
    <script>
        let EMBEDDED_LAYOUT = {
            "panel_name": "MTM Workshop System Default Layout - Aligned Jacks",
            "controls": {
            "knob-large-100": {"type": "knob-large", "x": "9.44%", "y": "15.15%"},
            "knob-large-101": {"type": "knob-large", "x": "28.67%", "y": "15.08%"},
            "knob-large-102": {"type": "knob-large", "x": "66.37%", "y": "15.34%"},
            "knob-large-103": {"type": "knob-large", "x": "66.34%", "y": "87.69%"},
            "knob-large-104": {"type": "knob-large", "x": "28.46%", "y": "87.71%"},
            "knob-large-105": {"type": "knob-large", "x": "92.62%", "y": "87.65%"},
            "knob-medium-106": {"type": "knob-medium", "x": "78.87%", "y": "13.12%"},
            "knob-medium-107": {"type": "knob-medium", "x": "78.74%", "y": "89.30%"},
            "knob-medium-108": {"type": "knob-medium", "x": "51.35%", "y": "16.82%"},
            "knob-small-109": {"type": "knob-small", "x": "3.25%", "y": "32.53%"},
            "knob-small-110": {"type": "knob-small", "x": "9.58%", "y": "32.40%"},
            "knob-small-111": {"type": "knob-small", "x": "22.61%", "y": "32.51%"},
            "knob-small-112": {"type": "knob-small", "x": "34.14%", "y": "32.65%"},
            "knob-small-113": {"type": "knob-small", "x": "88.80%", "y": "13.18%"},
            "knob-small-114": {"type": "knob-small", "x": "96.39%", "y": "13.27%"},
            "knob-small-115": {"type": "knob-small", "x": "88.75%", "y": "23.31%"},
            "knob-small-116": {"type": "knob-small", "x": "96.47%", "y": "23.28%"},
            "knob-small-117": {"type": "knob-small", "x": "96.47%", "y": "33.55%"},
            "knob-small-118": {"type": "knob-small", "x": "88.80%", "y": "33.52%"},
            "jack-119": {"type": "jack", "x": "2.47%", "y": "46.15%"},
            "jack-120": {"type": "jack", "x": "7.15%", "y": "46.15%"},
            "jack-121": {"type": "jack", "x": "11.94%", "y": "46.15%"},
            "jack-122": {"type": "jack", "x": "16.61%", "y": "46.15%"},
            "jack-123": {"type": "jack", "x": "2.47%", "y": "57.05%"},
            "jack-124": {"type": "jack", "x": "7.22%", "y": "57.05%"},
            "jack-125": {"type": "jack", "x": "11.94%", "y": "57.05%"},
            "jack-126": {"type": "jack", "x": "16.61%", "y": "57.05%"},
            "jack-127": {"type": "jack", "x": "2.45%", "y": "67.95%"},
            "jack-128": {"type": "jack", "x": "7.15%", "y": "67.95%"},
            "jack-129": {"type": "jack", "x": "11.94%", "y": "67.95%"},
            "jack-130": {"type": "jack", "x": "16.61%", "y": "67.95%"},
            "jack-131": {"type": "jack", "x": "21.40%", "y": "46.15%"},
            "jack-132": {"type": "jack", "x": "21.40%", "y": "57.05%"},
            "jack-133": {"type": "jack", "x": "26.09%", "y": "57.05%"},
            "jack-134": {"type": "jack", "x": "26.07%", "y": "46.15%"},
            "jack-135": {"type": "jack", "x": "30.87%", "y": "46.15%"},
            "jack-136": {"type": "jack", "x": "30.87%", "y": "57.05%"},
            "jack-137": {"type": "jack", "x": "35.56%", "y": "46.15%"},
            "jack-138": {"type": "jack", "x": "35.59%", "y": "57.05%"},
            "jack-139": {"type": "jack", "x": "40.43%", "y": "46.15%"},
            "jack-140": {"type": "jack", "x": "40.38%", "y": "57.05%"},
            "jack-141": {"type": "jack", "x": "45.10%", "y": "57.05%"},
            "jack-142": {"type": "jack", "x": "45.10%", "y": "46.15%"},
            "jack-143": {"type": "jack", "x": "49.84%", "y": "46.15%"},
            "jack-144": {"type": "jack", "x": "54.55%", "y": "46.15%"},
            "jack-145": {"type": "jack", "x": "49.89%", "y": "57.05%"},
            "jack-146": {"type": "jack", "x": "54.56%", "y": "57.05%"},
            "jack-147": {"type": "jack", "x": "59.25%", "y": "57.05%"},
            "jack-148": {"type": "jack", "x": "59.25%", "y": "46.15%"},
            "jack-149": {"type": "jack", "x": "63.97%", "y": "46.15%"},
            "jack-150": {"type": "jack", "x": "64.02%", "y": "57.05%"},
            "jack-151": {"type": "jack", "x": "68.79%", "y": "57.05%"},
            "jack-152": {"type": "jack", "x": "68.79%", "y": "46.15%"},
            "jack-153": {"type": "jack", "x": "73.49%", "y": "46.15%"},
            "jack-154": {"type": "jack", "x": "73.50%", "y": "57.05%"},
            "jack-155": {"type": "jack", "x": "78.28%", "y": "57.05%"},
            "jack-156": {"type": "jack", "x": "78.28%", "y": "46.15%"},
            "jack-157": {"type": "jack", "x": "82.95%", "y": "46.15%"},
            "jack-159": {"type": "jack", "x": "82.95%", "y": "57.05%"},
            "jack-160": {"type": "jack", "x": "87.72%", "y": "46.15%"},
            "jack-161": {"type": "jack", "x": "87.72%", "y": "57.05%"},
            "jack-162": {"type": "jack", "x": "92.47%", "y": "57.05%"},
            "jack-163": {"type": "jack", "x": "92.42%", "y": "46.15%"},
            "jack-164": {"type": "jack", "x": "97.23%", "y": "46.15%"},
            "jack-165": {"type": "jack", "x": "97.12%", "y": "57.05%"},
            "jack-166": {"type": "jack", "x": "92.52%", "y": "67.95%"},
            "jack-167": {"type": "jack", "x": "45.10%", "y": "13.58%"},
            "jack-168": {"type": "jack", "x": "45.10%", "y": "35.15%"},
            "jack-169": {"type": "jack", "x": "97.21%", "y": "67.95%"},
            "jack-170": {"type": "jack", "x": "82.92%", "y": "67.95%"},
            "jack-171": {"type": "jack", "x": "78.25%", "y": "35.15%"},
            "jack-172": {"type": "jack", "x": "49.79%", "y": "35.15%"},
            "jack-173": {"type": "jack", "x": "54.56%", "y": "35.15%"},
            "jack-174": {"type": "jack", "x": "40.43%", "y": "35.15%"},
            "jack-175": {"type": "jack", "x": "40.33%", "y": "13.58%"},
            "jack-177": {"type": "jack", "x": "40.33%", "y": "89.04%"},
            "jack-178": {"type": "jack", "x": "45.03%", "y": "89.04%"},
            "knob-small-179": {"type": "knob-small", "x": "60.12%", "y": "32.53%"},
            "knob-small-180": {"type": "knob-small", "x": "72.55%", "y": "32.53%"},
            "knob-small-184": {"type": "knob-small", "x": "22.70%", "y": "70.66%"},
            "knob-small-185": {"type": "knob-small", "x": "34.20%", "y": "70.56%"},
            "knob-small-186": {"type": "knob-small", "x": "40.34%", "y": "76.35%"},
            "knob-small-187": {"type": "knob-small", "x": "44.53%", "y": "67.50%"},
            "knob-small-188": {"type": "knob-small", "x": "52.26%", "y": "67.50%"},
            "knob-small-189": {"type": "knob-small", "x": "60.12%", "y": "70.43%"},
            "knob-small-190": {"type": "knob-small", "x": "72.52%", "y": "70.35%"},
            "switch-2way-191": {"type": "switch-2way", "x": "52.25%", "y": "26.57%"},
            "switch-2way-192": {"type": "switch-2way", "x": "66.46%", "y": "70.40%"},
            "switch-2way-194": {"type": "switch-2way", "x": "66.46%", "y": "32.66%"},
            "switch-3way-195": {"type": "switch-3way", "x": "77.90%", "y": "24.60%"},
            "switch-3way-196": {"type": "switch-3way", "x": "83.25%", "y": "24.60%"},
            "switch-3way-197": {"type": "switch-3way", "x": "77.90%", "y": "78.25%"},
            "switch-3way-198": {"type": "switch-3way", "x": "83.25%", "y": "78.25%"},
            "switch-3way-199": {"type": "switch-3way", "x": "15.70%", "y": "31.40%"},
            "button-1": {"type": "button", "x": "50.35%", "y": "79.9%"},
            "button-2": {"type": "button", "x": "56%", "y": "79.9%"},
            "button-3": {"type": "button", "x": "50.35%", "y": "89.5%"},
            "button-4": {"type": "button", "x": "56%", "y": "89.5%"}
        }
        }
        
        let currentCableStart = null;
        let cableData = [];
        let noteData = [];
        let componentStates = {}; 
        let componentPositions = EMBEDDED_LAYOUT.controls; 
        
        let isDraggingKnob = false;

        function getComponentPosition(id) {
            const el = document.getElementById(id);
            if (!el) return null;
            const container = el.parentElement;
            const containerRect = container.getBoundingClientRect();
            const elRect = el.getBoundingClientRect();
            return {
                x: elRect.left + elRect.width / 2 - containerRect.left,
                y: elRect.top + elRect.height / 2 - containerRect.top
            };
        }

        function showMessage(text, type = 'info') {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = text;
            msgBox.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-2xl transition-opacity duration-300 opacity-100 z-50';
            if (type === 'error') msgBox.classList.add('bg-red-700', 'text-white');
            else if (type === 'success') msgBox.classList.add('bg-green-600', 'text-white');
            else if (type === 'warning') msgBox.classList.add('bg-yellow-600', 'text-white');
            else msgBox.classList.add('bg-gray-800', 'text-white');
            
            msgBox.classList.remove('hidden', 'opacity-0');
            setTimeout(() => {
                msgBox.classList.remove('opacity-100');
                msgBox.classList.add('opacity-0');
                setTimeout(() => msgBox.classList.add('hidden'), 300);
            }, 3000);
        }

        function getRandomColor() {
            const colors = ['#ef4444', '#10b981', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function savePatchToFile() {
            saveNotePositions();
            const patchName = document.getElementById('patchNameInput').value.trim() || "Untitled";
            
            const patch = {
                timestamp: Date.now(),
                patchName: patchName,
                globalNotes: document.getElementById('globalNotesArea').value,
                cables: cableData,
                notes: noteData,
                componentStates: componentStates 
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(patch, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const filename = patchName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".json";
            downloadAnchorNode.setAttribute("download", filename);
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showMessage(`Saved "${patchName}"`, 'success');
        }

        function triggerLoadFile() {
            document.getElementById('loadPatchInput').click();
        }

        function loadPatchFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const patch = JSON.parse(e.target.result);
                    cableData = []; noteData = [];
                    document.getElementById('cableLayer').innerHTML = '';
                    document.querySelectorAll('.note-element').forEach(el => el.remove());
                    
                    cableData = patch.cables || [];
                    noteData = patch.notes || [];
                    componentStates = patch.componentStates || {};
                    document.getElementById('globalNotesArea').value = patch.globalNotes || "";
                    document.getElementById('patchNameInput').value = patch.patchName || "";

                    renderComponents(); 
                    
                    const container = document.getElementById('synthContainer');
                    noteData.forEach(n => container.appendChild(createNoteElement(n)));
                    redrawCables();
                    
                    showMessage(`Loaded "${patch.patchName || 'patch'}"`, 'success');
                } catch (error) {
                    console.error(error);
                    showMessage('Error parsing JSON file.', 'error');
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function getScreenshotCanvas(callback) {
            const container = document.getElementById('synthContainer');
            document.querySelectorAll('.note-element').forEach(el => el.style.border = 'none');
            
            html2canvas(container, {
                allowTaint: true, 
                useCORS: true, 
                backgroundColor: null, 
                scale: 2
            }).then(canvas => {
                document.querySelectorAll('.note-element').forEach(el => el.style.border = '');
                callback(canvas);
            }).catch(err => {
                console.error(err);
                document.querySelectorAll('.note-element').forEach(el => el.style.border = '');
                showMessage('Screenshot failed. Needs web server?', 'error');
            });
        }

        function savePatchAsPng() {
            getScreenshotCanvas((canvas) => {
                const patchName = document.getElementById('patchNameInput').value.trim() || "patch";
                const filename = patchName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".png";
                
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage('PNG saved!', 'success');
            });
        }

        function savePatchAsPdf() {
            getScreenshotCanvas((canvas) => {
                const patchName = document.getElementById('patchNameInput').value.trim() || "patch";
                const filename = patchName.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".pdf";

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.setFontSize(16);
                pdf.text(patchName, 10, 10);
                pdf.addImage(imgData, 'PNG', 0, 15, pdfWidth, pdfHeight);
                
                const notes = document.getElementById('globalNotesArea').value;
                if(notes) {
                    pdf.setFontSize(10);
                    const splitNotes = pdf.splitTextToSize(notes, pdfWidth - 20);
                    pdf.text(splitNotes, 10, 15 + pdfHeight + 10);
                }

                pdf.save(filename);
                showMessage('PDF saved!', 'success');
            });
        }
        
        function drawCable(startId, endId, color, isTemporary = false, mouseX = 0, mouseY = 0) {
            const cableLayer = document.getElementById('cableLayer');
            const containerRect = cableLayer.getBoundingClientRect();
            const svgPathId = `cable-${startId}-${endId}`;

            let startPos = getComponentPosition(startId);
            let endPos;

            if (isTemporary) {
                endPos = { x: mouseX - containerRect.left, y: mouseY - containerRect.top };
            } else {
                endPos = getComponentPosition(endId);
            }
            if (!startPos || !endPos) return;

            const dx = endPos.x - startPos.x;
            const dy = endPos.y - startPos.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const drop = Math.min(length * 0.3, 150); 
            
            const cX1 = startPos.x + dx * 0.25;
            const cY1 = startPos.y + drop;
            const cX2 = endPos.x - dx * 0.25;
            const cY2 = endPos.y + drop;

            const d = `M${startPos.x},${startPos.y} C${cX1},${cY1} ${cX2},${cY2} ${endPos.x},${endPos.y}`;

            let path = document.getElementById(isTemporary ? 'tempCable' : svgPathId);
            
            if (!path) {
                path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.id = isTemporary ? 'tempCable' : svgPathId;
                if(!isTemporary) {
                    const remove = (e) => {
                        if (e.type === 'contextmenu' || e.type === 'dblclick') {
                            e.preventDefault();
                            removeCable(startId, endId);
                        }
                    };
                    path.addEventListener('contextmenu', remove);
                    path.addEventListener('dblclick', remove);
                }
                cableLayer.appendChild(path);
            }
            path.setAttribute('d', d);
            path.setAttribute('stroke', color);
            path.setAttribute('opacity', isTemporary ? '0.6' : '0.9');
        }

        function removeCable(startId, endId) {
            let path = document.getElementById(`cable-${startId}-${endId}`);
            if (!path) path = document.getElementById(`cable-${endId}-${startId}`);
            if (path) path.remove();

            cableData = cableData.filter(c => 
                !(c.start === startId && c.end === endId) && !(c.start === endId && c.end === startId)
            );
            document.getElementById(startId)?.classList.remove('active');
            document.getElementById(endId)?.classList.remove('active');
        }

        function handleJackClick(event) {
            const jackId = event.currentTarget.id;
            if (event.type === 'contextmenu') {
                event.preventDefault();
                const cable = cableData.find(c => c.start === jackId || c.end === jackId);
                if (cable) removeCable(cable.start, cable.end);
                return;
            }
            if (currentCableStart === jackId) {
                currentCableStart = null;
                event.currentTarget.classList.remove('active');
                document.getElementById('tempCable')?.remove();
                return;
            }
            if (currentCableStart === null) {
                currentCableStart = jackId;
                event.currentTarget.classList.add('active');
            } else {
                const isDuplicate = cableData.some(c => (c.start === currentCableStart && c.end === jackId) || (c.start === jackId && c.end === currentCableStart));
                if (!isDuplicate) {
                    const newCable = { start: currentCableStart, end: jackId, color: getRandomColor() };
                    cableData.push(newCable);
                    drawCable(newCable.start, newCable.end, newCable.color);
                }
                document.getElementById(currentCableStart)?.classList.remove('active');
                document.getElementById(jackId)?.classList.remove('active');
                currentCableStart = null;
                document.getElementById('tempCable')?.remove();
            }
        }

        function handleMouseMove(event) {
            if (currentCableStart !== null) {
                drawCable(currentCableStart, null, '#000000', true, event.clientX, event.clientY);
            }
        }

        function redrawCables() {
            document.getElementById('cableLayer').innerHTML = ''; 
            cableData.forEach(c => drawCable(c.start, c.end, c.color));
        }

        function updateKnobAngle(el, angle) {
            if (!el) return;
            const norm = Math.max(-150, Math.min(150, angle));
            el.style.setProperty('--angle', norm);
            el.setAttribute('data-angle', norm);
            
            if(!componentStates[el.id]) componentStates[el.id] = { type: 'knob' };
            componentStates[el.id].value = norm;
        }

        function startKnobDrag(e) {
            e.stopPropagation(); e.preventDefault();
            const isTouch = e.type.includes('touch');
            const cx = isTouch ? e.touches[0].clientX : e.clientX;
            const cy = isTouch ? e.touches[0].clientY : e.clientY;
            
            currentKnobElement = e.currentTarget;
            isDraggingKnob = true;
            
            const rect = currentKnobElement.getBoundingClientRect();
            currentKnobElement.dataset.centerX = rect.left + rect.width / 2;
            currentKnobElement.dataset.centerY = rect.top + rect.height / 2;
            
            currentKnobElement.dataset.currentAngle = parseFloat(currentKnobElement.dataset.angle || 0);
            
            const dx = cx - currentKnobElement.dataset.centerX;
            const dy = cy - currentKnobElement.dataset.centerY;
            const rads = Math.atan2(dy, dx);
            currentKnobElement.dataset.startMouseDeg = (rads * (180/Math.PI)) + 90;

            document.addEventListener(isTouch ? 'touchmove' : 'mousemove', dragKnob);
            document.addEventListener(isTouch ? 'touchend' : 'mouseup', stopKnobDrag);
        }

        function dragKnob(e) {
            if (!isDraggingKnob || !currentKnobElement) return;
            const isTouch = e.type.includes('touch');
            const cx = isTouch ? e.touches[0].clientX : e.clientX;
            const cy = isTouch ? e.touches[0].clientY : e.clientY;
            
            const dx = cx - currentKnobElement.dataset.centerX;
            const dy = cy - currentKnobElement.dataset.centerY;
            
            let mouseDeg = (Math.atan2(dy, dx) * (180/Math.PI)) + 90;
            let delta = mouseDeg - parseFloat(currentKnobElement.dataset.startMouseDeg);
            
            if (delta > 180) delta -= 360;
            if (delta < -180) delta += 360;

            let newAngle = parseFloat(currentKnobElement.dataset.currentAngle) + delta;
            updateKnobAngle(currentKnobElement, newAngle);
            
            currentKnobElement.dataset.currentAngle = newAngle;
            currentKnobElement.dataset.startMouseDeg = mouseDeg;
        }

        function stopKnobDrag() {
            isDraggingKnob = false; currentKnobElement = null;
            document.removeEventListener('mousemove', dragKnob);
            document.removeEventListener('mouseup', stopKnobDrag);
            document.removeEventListener('touchmove', dragKnob);
            document.removeEventListener('touchend', stopKnobDrag);
        }

        function handleSwitchClick(e) {
            const el = e.currentTarget;
            const is3Way = el.classList.contains('switch-3way');
            const max = is3Way ? 3 : 2;
            
            let currentVal = parseInt(el.dataset.state || 0);
            let nextVal = (currentVal + 1) % max;
            
            el.setAttribute('data-state', nextVal);
            componentStates[el.id] = { type: is3Way ? 'switch-3way' : 'switch-2way', value: nextVal };
        }

        function handleButtonClick(e) {
            const el = e.currentTarget;
            let val = parseInt(el.dataset.state || 0) === 0 ? 1 : 0;
            el.setAttribute('data-state', val);
            componentStates[el.id] = { type: 'button', value: val };
        }

        function createNoteElement(data) {
            const el = document.createElement('div');
            el.className = 'note-element';
            el.id = data.id || `note-${Date.now()}`;
            el.style.left = data.x; el.style.top = data.y;
            el.textContent = data.text || 'Label';
            el.contentEditable = true;
            
            el.addEventListener('mousedown', startDragNote);
            el.addEventListener('touchstart', startDragNote);
            el.addEventListener('dblclick', () => removeNote(el));
            el.addEventListener('focus', () => el.setAttribute('draggable', false));
            el.addEventListener('blur', () => {
                el.setAttribute('draggable', true);
                saveNotePositions();
            });

            return el;
        }

        function addNewNote() {
            const data = { id: `note-${Date.now()}`, x: '50%', y: '50%', text: 'New Label' };
            document.getElementById('synthContainer').appendChild(createNoteElement(data));
            noteData.push(data);
        }

        function removeNote(el) {
            noteData = noteData.filter(n => n.id !== el.id);
            el.remove();
        }

        function startDragNote(e) {
            if (document.activeElement === e.target) return;
            e.stopPropagation();
            const isTouch = e.type.includes('touch');
            currentDragElement = e.currentTarget; 
            currentDragElement.style.zIndex = 100;
            
            const rect = currentDragElement.getBoundingClientRect();
            const cx = isTouch ? e.touches[0].clientX : e.clientX;
            const cy = isTouch ? e.touches[0].clientY : e.clientY;
            offsetX = cx - rect.left;
            offsetY = cy - rect.top;
            
            document.addEventListener(isTouch?'touchmove':'mousemove', dragNote);
            document.addEventListener(isTouch?'touchend':'mouseup', stopDragNote);
        }

        function dragNote(e) {
            if(!currentDragElement) return;
            e.preventDefault();
            const isTouch = e.type.includes('touch');
            const container = document.getElementById('synthContainer').getBoundingClientRect();
            const cx = isTouch ? e.touches[0].clientX : e.clientX;
            const cy = isTouch ? e.touches[0].clientY : e.clientY;
            
            const elRect = currentDragElement.getBoundingClientRect();
            let nx = cx - container.left - offsetX + elRect.width/2;
            let ny = cy - container.top - offsetY + elRect.height/2;
            
            currentDragElement.style.left = `${(nx/container.width)*100}%`;
            currentDragElement.style.top = `${(ny/container.height)*100}%`;
        }

        function stopDragNote() {
            if (currentDragElement) currentDragElement.style.zIndex = 20;
            currentDragElement = null;
            document.removeEventListener('mousemove', dragNote);
            document.removeEventListener('mouseup', stopDragNote);
            document.removeEventListener('touchmove', dragNote);
            document.removeEventListener('touchend', stopDragNote);
            saveNotePositions();
        }

        function saveNotePositions() {
            const container = document.getElementById('synthContainer').getBoundingClientRect();
            noteData = Array.from(document.querySelectorAll('.note-element')).map(el => {
                const rect = el.getBoundingClientRect();
                const cx = rect.left + rect.width/2 - container.left;
                const cy = rect.top + rect.height/2 - container.top;
                return {
                    id: el.id,
                    x: `${(cx/container.width)*100}%`,
                    y: `${(cy/container.height)*100}%`,
                    text: el.textContent
                };
            });
        }

        function clearPatch(showMsg=true) {
            cableData = []; noteData = []; componentStates = {};
            document.getElementById('globalNotesArea').value = "";
            document.getElementById('patchNameInput').value = "";
            document.getElementById('cableLayer').innerHTML = '';
            document.querySelectorAll('.note-element').forEach(e => e.remove());
            renderComponents();
            if(showMsg) showMessage('All cleared.');
        }

        function createComponent(id, config) {
            const el = document.createElement('div');
            el.className = `component ${config.type}`;
            el.id = id;
            el.style.left = config.x; el.style.top = config.y;
            
            const saved = componentStates[id];

            if (config.type.includes('jack')) {
                el.classList.add('jack');
                el.addEventListener('click', handleJackClick);
                el.addEventListener('contextmenu', handleJackClick);
            
            } else if (config.type.startsWith('knob')) {
                el.addEventListener('mousedown', startKnobDrag);
                el.addEventListener('touchstart', startKnobDrag);
                updateKnobAngle(el, saved ? saved.value : 0);
            
            } else if (config.type.startsWith('switch')) {
                el.addEventListener('click', handleSwitchClick);
                el.setAttribute('data-state', saved ? saved.value : 0);
                const handle = document.createElement('div');
                handle.className = 'switch-handle';
                el.appendChild(handle);
            
            } else if (config.type === 'button') {
                el.classList.add('button');
                el.addEventListener('click', handleButtonClick);
                el.setAttribute('data-state', saved ? saved.value : 0);
            }
            
            if (!componentStates[id]) {
                 componentStates[id] = { 
                     type: config.type, 
                     value: (config.type.startsWith('knob')) ? 0 : 0 
                 };
            }

            return el;
        }

        function renderComponents() {
            const container = document.getElementById('synthContainer');
            container.querySelectorAll('.component').forEach(el => el.remove());
            for (const [id, config] of Object.entries(componentPositions)) {
                container.appendChild(createComponent(id, config));
            }
        }

        window.onload = function() {
            renderComponents();
            
            document.getElementById('synthContainer').addEventListener('mousemove', handleMouseMove);
            window.addEventListener('resize', redrawCables);
            
            document.getElementById('addNoteButton').addEventListener('click', addNewNote);
            document.getElementById('savePngButton').addEventListener('click', savePatchAsPng);
            document.getElementById('savePdfButton').addEventListener('click', savePatchAsPdf);
            document.getElementById('clearButton').addEventListener('click', () => clearPatch(true));
            document.getElementById('savePatchButton').addEventListener('click', savePatchToFile);
            document.getElementById('loadPatchButton').addEventListener('click', triggerLoadFile);
            document.getElementById('loadPatchInput').addEventListener('change', loadPatchFromFile);
            
            showMessage('Ready to patch!', 'info');
        };
    </script>
</body>
</html>